<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DA1.1 Tracker - {% block title %}{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">DA1.1 Tracker</a>
            <div class="navbar-nav me-auto">
                <a class="nav-link" href="{{ url_for('index') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('records') }}">All Records</a>
                {% if current_user.is_authenticated and current_user.is_admin() %}
                    <a class="nav-link" href="{{ url_for('add_record') }}">Add Record</a>
                {% endif %}
            </div>
            <div class="navbar-nav ms-auto">
                {% if current_user.is_authenticated and current_user.is_admin() %}
                    <div class="nav-item notification-bell-container">
                        <button class="btn notification-bell-btn" data-bs-toggle="dropdown" aria-expanded="false" id="notificationBellBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                            {% if get_pending_registration_count() > 0 %}
                                <span class="notification-badge" id="notificationBadge">{{ get_pending_registration_count() }}</span>
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end notification-dropdown" id="notificationDropdown">
                            <li><span class="notification-empty">No pending requests</span></li>
                        </ul>
                    </div>
                {% endif %}
                {% if current_user.is_authenticated %}
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false" id="userDropdown">
                            Welcome, {{ current_user.forename }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editProfileModal">Edit Profile</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">Change Password</a></li>
                            {% if current_user.is_admin() %}
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#manageUsersModal">Manage Users</a></li>
                            {% endif %}
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">Delete Account</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header modal-header-band">
                    <h5 class="modal-title">Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label for="profileForename" class="form-label field-label-purple">Forename</label>
                            <input type="text" class="form-control" id="profileForename" name="forename"
                                   value="{{ current_user.forename if current_user.is_authenticated else '' }}" disabled required>
                        </div>
                        <div class="mb-3">
                            <label for="profileSurname" class="form-label field-label-purple">Surname</label>
                            <input type="text" class="form-control" id="profileSurname" name="surname"
                                   value="{{ current_user.surname if current_user.is_authenticated else '' }}" disabled required>
                        </div>
                        <div class="mb-3">
                            <label for="profileEmail" class="form-label field-label-purple">Email</label>
                            <input type="email" class="form-control" id="profileEmail" name="email"
                                   value="{{ current_user.email if current_user.is_authenticated else '' }}" disabled required>
                        </div>
                        <div class="mb-3">
                            <label for="profileJobTitle" class="form-label field-label-purple">Job Title</label>
                            <input type="text" class="form-control" id="profileJobTitle" name="job_title"
                                   value="{{ current_user.job_title if current_user.is_authenticated else '' }}" disabled required>
                        </div>
                        <div class="mb-3">
                            <label for="profileTelephone" class="form-label field-label-purple">Telephone</label>
                            <input type="tel" class="form-control" id="profileTelephone" name="telephone"
                                   value="{{ current_user.telephone if current_user.is_authenticated and current_user.telephone else '' }}" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label field-label-purple">Role</label>
                            <input type="text" class="form-control"
                                   value="{% if current_user.is_authenticated %}{% if current_user.is_admin() %}Admin{% else %}Non-Admin{% endif %}{% endif %}"
                                   disabled readonly>
                        </div>
                        <div id="profileMessage" class="alert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer" id="profileFooterView">
                    <button type="button" class="btn btn-warning" onclick="enableProfileEdit()">Edit Details</button>
                </div>
                <div class="modal-footer" id="profileFooterEdit" style="display: none;">
                    <button type="button" class="btn btn-warning" onclick="cancelProfileEdit()">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="saveProfile()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="modal fade" id="deleteAccountModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header modal-header-band">
                    <h5 class="modal-title">Delete Account</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you wish to delete your account?</p>
                    <p class="text-muted small">This action will log you out and you will no longer be able to access the system.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="confirmDeleteAccount()">Yes, delete my account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header modal-header-band">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label field-label-purple">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label field-label-purple">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="new_password" required>
                            <div class="form-text">Password must be at least 8 characters long.</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmNewPassword" class="form-label field-label-purple">Re-enter New Password</label>
                            <input type="password" class="form-control" id="confirmNewPassword" name="confirm_password" required>
                        </div>
                        <div id="passwordChangeMessage" class="alert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal" onclick="resetPasswordForm()">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="changePassword()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header modal-header-band">
                    <h5 class="modal-title">Review Registration Request</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="approvalModalName"></p>
                    <p id="approvalModalEmail"></p>
                    <p id="approvalModalDate"></p>
                    <input type="hidden" id="approvalUserId" value="">
                    <div id="approvalModalMessage" class="alert" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="approvalAcceptBtn" onclick="handleApproval('approve')">Accept</button>
                    <button type="button" class="btn btn-danger" id="approvalRejectBtn" onclick="handleApproval('reject')">Reject</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Users Modal -->
    {% if current_user.is_authenticated and current_user.is_admin() %}
    <div class="modal fade" id="manageUsersModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-band">
                    <h5 class="modal-title">Manage Users</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Forename</th>
                                    <th>Surname</th>
                                    <th>Email</th>
                                    <th>Job Title</th>
                                    <th>Role</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="6" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header modal-header-band">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId" name="user_id">
                        <div class="mb-3">
                            <label for="editUserForename" class="form-label field-label-purple">Forename</label>
                            <input type="text" class="form-control" id="editUserForename" name="forename" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserSurname" class="form-label field-label-purple">Surname</label>
                            <input type="text" class="form-control" id="editUserSurname" name="surname" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserEmail" class="form-label field-label-purple">Email</label>
                            <input type="email" class="form-control" id="editUserEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserJobTitle" class="form-label field-label-purple">Job Title</label>
                            <input type="text" class="form-control" id="editUserJobTitle" name="job_title" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserTelephone" class="form-label field-label-purple">Telephone</label>
                            <input type="tel" class="form-control" id="editUserTelephone" name="telephone">
                        </div>
                        <div class="mb-3">
                            <label for="editUserRole" class="form-label field-label-purple">Role</label>
                            <select class="form-select" id="editUserRole" name="role" required>
                                <option value="admin">Admin</option>
                                <option value="viewer">Non-admin</option>
                            </select>
                        </div>
                        <div id="editUserMessage" class="alert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="saveUserEdit()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header modal-header-band">
                    <h5 class="modal-title">Delete User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="deleteUserId">
                    <p>Are you sure you want to delete <strong id="deleteUserName"></strong>?</p>
                    <p class="text-muted small">This action will prevent the user from logging in.</p>
                    <div id="deleteUserMessage" class="alert" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-warning" onclick="deleteUser()">Yes</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    let originalProfileData = {};

    function enableProfileEdit() {
        originalProfileData = {
            forename: document.getElementById('profileForename').value,
            surname: document.getElementById('profileSurname').value,
            email: document.getElementById('profileEmail').value,
            job_title: document.getElementById('profileJobTitle').value,
            telephone: document.getElementById('profileTelephone').value
        };

        document.getElementById('profileForename').disabled = false;
        document.getElementById('profileSurname').disabled = false;
        document.getElementById('profileEmail').disabled = false;
        document.getElementById('profileJobTitle').disabled = false;
        document.getElementById('profileTelephone').disabled = false;

        document.getElementById('profileFooterView').style.display = 'none';
        document.getElementById('profileFooterEdit').style.display = 'flex';
    }

    function cancelProfileEdit() {
        document.getElementById('profileForename').value = originalProfileData.forename;
        document.getElementById('profileSurname').value = originalProfileData.surname;
        document.getElementById('profileEmail').value = originalProfileData.email;
        document.getElementById('profileJobTitle').value = originalProfileData.job_title;
        document.getElementById('profileTelephone').value = originalProfileData.telephone;

        document.getElementById('profileForename').disabled = true;
        document.getElementById('profileSurname').disabled = true;
        document.getElementById('profileEmail').disabled = true;
        document.getElementById('profileJobTitle').disabled = true;
        document.getElementById('profileTelephone').disabled = true;

        document.getElementById('profileFooterView').style.display = 'flex';
        document.getElementById('profileFooterEdit').style.display = 'none';
        document.getElementById('profileMessage').style.display = 'none';
    }

    function saveProfile() {
        const formData = new FormData(document.getElementById('editProfileForm'));
        const messageDiv = document.getElementById('profileMessage');

        fetch('{{ url_for("update_profile") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.className = 'alert alert-success';
                messageDiv.textContent = data.message;
                messageDiv.style.display = 'block';

                document.getElementById('profileForename').disabled = true;
                document.getElementById('profileSurname').disabled = true;
                document.getElementById('profileEmail').disabled = true;
                document.getElementById('profileJobTitle').disabled = true;
                document.getElementById('profileTelephone').disabled = true;

                document.getElementById('profileFooterView').style.display = 'flex';
                document.getElementById('profileFooterEdit').style.display = 'none';

                const newForename = document.getElementById('profileForename').value;
                document.getElementById('userDropdown').textContent = 'Welcome, ' + newForename;

                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                }, 2000);
            } else {
                messageDiv.className = 'alert alert-danger';
                messageDiv.textContent = data.message;
                messageDiv.style.display = 'block';
            }
        });
    }

    function confirmDeleteAccount() {
        fetch('{{ url_for("delete_account") }}', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('deleteAccountModal')).hide();
                alert('Your account has been deleted successfully. You will now be logged out.');
                window.location.href = '{{ url_for("login") }}';
            } else {
                alert('Error: ' + data.message);
            }
        });
    }

    function resetPasswordForm() {
        document.getElementById('changePasswordForm').reset();
        document.getElementById('passwordChangeMessage').style.display = 'none';
    }

    function changePassword() {
        const formData = new FormData(document.getElementById('changePasswordForm'));
        const messageDiv = document.getElementById('passwordChangeMessage');

        // Client-side validation
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmNewPassword').value;

        if (newPassword !== confirmPassword) {
            messageDiv.className = 'alert alert-danger';
            messageDiv.textContent = 'New passwords do not match.';
            messageDiv.style.display = 'block';
            return;
        }

        if (newPassword.length < 8) {
            messageDiv.className = 'alert alert-danger';
            messageDiv.textContent = 'Password must be at least 8 characters long.';
            messageDiv.style.display = 'block';
            return;
        }

        fetch('{{ url_for("change_password") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.className = 'alert alert-success';
                messageDiv.textContent = data.message;
                messageDiv.style.display = 'block';

                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                    resetPasswordForm();
                }, 2000);
            } else {
                messageDiv.className = 'alert alert-danger';
                messageDiv.textContent = data.message;
                messageDiv.style.display = 'block';
            }
        });
    }

    // Reset form when modal is closed
    document.getElementById('changePasswordModal').addEventListener('hidden.bs.modal', function () {
        resetPasswordForm();
    });
    </script>

    {% block scripts %}{% endblock %}

    {% if current_user.is_authenticated and current_user.is_admin() %}
    <script>
    // User management functions
    let usersData = [];

    function fetchUsers() {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

        fetch('/admin/users')
            .then(response => response.json())
            .then(users => {
                usersData = users;
                tbody.innerHTML = '';
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users found.</td></tr>';
                } else {
                    users.forEach(user => {
                        const roleDisplay = user.role === 'admin' ? 'Admin' : 'Non-admin';
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-user-id', user.id);
                        tr.innerHTML =
                            '<td>' + escapeHtml(user.forename) + '</td>' +
                            '<td>' + escapeHtml(user.surname) + '</td>' +
                            '<td>' + escapeHtml(user.email) + '</td>' +
                            '<td>' + escapeHtml(user.job_title) + '</td>' +
                            '<td>' + roleDisplay + '</td>' +
                            '<td>' +
                                '<button class="btn btn-sm btn-outline-secondary me-1" onclick="openEditUserModal(' + user.id + ')" title="Edit">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.854a.5.5 0 0 1 .708 0l2.292 2.292a.5.5 0 0 1 0 .708l-9.5 9.5a.5.5 0 0 1-.168.11l-4 1.5a.5.5 0 0 1-.65-.65l1.5-4a.5.5 0 0 1 .11-.168l9.5-9.5zm.708 2.354L11 1.354 12.646 3l1.854-1.854-1.646-1.792zM11.207 4l-8.5 8.5-1.012 2.696 2.696-1.012 8.5-8.5L11.207 4z"/></svg>' +
                                '</button>' +
                                '<button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteUser(' + user.id + ', \'' + escapeHtml(user.forename) + ' ' + escapeHtml(user.surname) + '\')" title="Delete">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>' +
                                '</button>' +
                            '</td>';
                        tbody.appendChild(tr);
                    });
                }
            })
            .catch(err => {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading users.</td></tr>';
                console.error('Failed to fetch users:', err);
            });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function openEditUserModal(userId) {
        const user = usersData.find(u => u.id === userId);
        if (!user) return;

        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUserForename').value = user.forename;
        document.getElementById('editUserSurname').value = user.surname;
        document.getElementById('editUserEmail').value = user.email;
        document.getElementById('editUserJobTitle').value = user.job_title;
        document.getElementById('editUserTelephone').value = user.telephone || '';
        document.getElementById('editUserRole').value = user.role;

        const msgDiv = document.getElementById('editUserMessage');
        msgDiv.style.display = 'none';

        bootstrap.Modal.getOrCreateInstance(document.getElementById('editUserModal')).show();
    }

    function saveUserEdit() {
        const userId = document.getElementById('editUserId').value;
        const formData = new FormData(document.getElementById('editUserForm'));
        const msgDiv = document.getElementById('editUserMessage');

        fetch('/admin/users/' + userId + '/update', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                msgDiv.className = 'alert alert-success';
                msgDiv.textContent = data.message;
                msgDiv.style.display = 'block';

                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    fetchUsers();
                }, 1500);
            } else {
                msgDiv.className = 'alert alert-danger';
                msgDiv.textContent = data.message;
                msgDiv.style.display = 'block';
            }
        })
        .catch(err => {
            msgDiv.className = 'alert alert-danger';
            msgDiv.textContent = 'An error occurred. Please try again.';
            msgDiv.style.display = 'block';
        });
    }

    function confirmDeleteUser(userId, userName) {
        document.getElementById('deleteUserId').value = userId;
        document.getElementById('deleteUserName').textContent = userName;

        const msgDiv = document.getElementById('deleteUserMessage');
        msgDiv.style.display = 'none';

        bootstrap.Modal.getOrCreateInstance(document.getElementById('deleteUserModal')).show();
    }

    function deleteUser() {
        const userId = document.getElementById('deleteUserId').value;
        const msgDiv = document.getElementById('deleteUserMessage');

        fetch('/admin/users/' + userId + '/delete', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                msgDiv.className = 'alert alert-success';
                msgDiv.textContent = data.message;
                msgDiv.style.display = 'block';

                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('deleteUserModal')).hide();
                    // Remove the row from the users table
                    const row = document.querySelector('#usersTableBody tr[data-user-id="' + userId + '"]');
                    if (row) row.remove();
                    // Update the usersData array
                    usersData = usersData.filter(u => u.id != userId);
                    if (usersData.length === 0) {
                        document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="6" class="text-center">No users found.</td></tr>';
                    }
                }, 1500);
            } else {
                msgDiv.className = 'alert alert-danger';
                msgDiv.textContent = data.message;
                msgDiv.style.display = 'block';
            }
        })
        .catch(err => {
            msgDiv.className = 'alert alert-danger';
            msgDiv.textContent = 'An error occurred. Please try again.';
            msgDiv.style.display = 'block';
        });
    }

    // Fetch users when the Manage Users modal is shown
    document.getElementById('manageUsersModal').addEventListener('show.bs.modal', function() {
        fetchUsers();
    });

    (function() {
        const bellBtn = document.getElementById('notificationBellBtn');
        const dropdown = document.getElementById('notificationDropdown');
        const badge = document.getElementById('notificationBadge');

        // Listen for Bootstrap dropdown show event on the bell button
        bellBtn.addEventListener('show.bs.dropdown', function() {
            fetchNotifications();
        });

        function fetchNotifications() {
            fetch('/admin/notifications')
                .then(response => response.json())
                .then(notifications => {
                    dropdown.innerHTML = '';
                    if (notifications.length === 0) {
                        dropdown.innerHTML = '<li><span class="notification-empty">No pending requests</span></li>';
                    } else {
                        notifications.forEach(n => {
                            const li = document.createElement('li');
                            li.innerHTML =
                                '<a class="dropdown-item notification-item" href="#" data-user-id="' + n.id + '" onclick="openApprovalModal(event)">' +
                                    '<span class="notification-name">' + n.forename + ' ' + n.surname + '</span>' +
                                    '<span class="notification-email">' + n.email + '</span>' +
                                    '<span class="notification-date">Registered: ' + n.registered_date + '</span>' +
                                '</a>';
                            dropdown.appendChild(li);
                        });
                    }
                })
                .catch(err => console.error('Failed to fetch notifications:', err));
        }

        function openApprovalModal(event) {
            event.preventDefault();
            const item = event.currentTarget;
            const userId = item.dataset.userId;
            const name = item.querySelector('.notification-name').textContent;
            const email = item.querySelector('.notification-email').textContent;
            const date = item.querySelector('.notification-date').textContent;

            document.getElementById('approvalUserId').value = userId;
            document.getElementById('approvalModalName').textContent = 'Name: ' + name;
            document.getElementById('approvalModalEmail').textContent = 'Email: ' + email;
            document.getElementById('approvalModalDate').textContent = date;

            const msgDiv = document.getElementById('approvalModalMessage');
            msgDiv.style.display = 'none';
            msgDiv.className = 'alert';
            msgDiv.textContent = '';

            // Enable buttons in case they were disabled after a previous action
            document.getElementById('approvalAcceptBtn').disabled = false;
            document.getElementById('approvalRejectBtn').disabled = false;

            // Close the dropdown first, then show modal
            bootstrap.Dropdown.getInstance(bellBtn).hide();
            bootstrap.Modal.getOrCreateInstance(document.getElementById('approvalModal')).show();
        }

        // Expose to global scope for onclick attributes
        window.openApprovalModal = openApprovalModal;

        window.handleApproval = function(action) {
            const userId = document.getElementById('approvalUserId').value;
            const msgDiv = document.getElementById('approvalModalMessage');

            // Disable buttons to prevent double-click
            document.getElementById('approvalAcceptBtn').disabled = true;
            document.getElementById('approvalRejectBtn').disabled = true;

            fetch('/admin/notifications/' + action + '/' + userId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    msgDiv.className = 'alert alert-success';
                    msgDiv.textContent = data.message;
                    msgDiv.style.display = 'block';

                    setTimeout(() => {
                        // Close the modal
                        bootstrap.Modal.getInstance(document.getElementById('approvalModal')).hide();

                        // Remove the item from the dropdown
                        const items = dropdown.querySelectorAll('[data-user-id="' + userId + '"]');
                        items.forEach(el => el.closest('li').remove());

                        // If dropdown is now empty, show placeholder
                        if (dropdown.querySelectorAll('.notification-item').length === 0) {
                            dropdown.innerHTML = '<li><span class="notification-empty">No pending requests</span></li>';
                        }

                        // Update badge
                        updateBadge();
                    }, 1500);
                } else {
                    msgDiv.className = 'alert alert-danger';
                    msgDiv.textContent = data.message;
                    msgDiv.style.display = 'block';
                    document.getElementById('approvalAcceptBtn').disabled = false;
                    document.getElementById('approvalRejectBtn').disabled = false;
                }
            })
            .catch(err => {
                msgDiv.className = 'alert alert-danger';
                msgDiv.textContent = 'An error occurred. Please try again.';
                msgDiv.style.display = 'block';
                document.getElementById('approvalAcceptBtn').disabled = false;
                document.getElementById('approvalRejectBtn').disabled = false;
            });
        };

        function updateBadge() {
            fetch('/admin/notifications')
                .then(response => response.json())
                .then(notifications => {
                    const count = notifications.length;
                    if (count > 0) {
                        if (!badge) {
                            // Badge element doesn't exist yet, create it
                            const newBadge = document.createElement('span');
                            newBadge.className = 'notification-badge';
                            newBadge.id = 'notificationBadge';
                            newBadge.textContent = count;
                            bellBtn.appendChild(newBadge);
                        } else {
                            badge.textContent = count;
                            badge.style.display = 'flex';
                        }
                    } else {
                        if (badge) {
                            badge.style.display = 'none';
                        }
                    }
                });
        }
    })();
    </script>
    {% endif %}
</body>
</html>
